# pylint: disable=missing-docstring
import socket
from rfc1928_constants import *
from socks5_structure import *
from socks5_structure import SOCKS5Request, SOCKS5Response
from time import sleep

TCP_SERVER_IP = '192.168.43.248'
TCP_SERVER_PORT = 1080

UDP_SERVER_IP = '192.168.43.248'
UDP_SERVER_PORT = 1080

tcpsocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
tcpsocket.bind((TCP_SERVER_IP, TCP_SERVER_PORT))
tcpsocket.listen(5)

udpsocket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
udpsocket.bind((UDP_SERVER_IP, UDP_SERVER_PORT))

BAIDU_HTTP_RESPONSE = bytes.fromhex('485454502f312e312033303220466f756e640d0a436f6e6e656374696f6e3a206b6565702d616c6976650d0a436f6e74656e742d4c656e6774683a203135340d0a436f6e74656e742d547970653a20746578742f68746d6c0d0a446174653a205765642c203036204d617220323032342031353a35373a353920474d540d0a4c6f636174696f6e3a2068747470733a2f2f7777772e62616964752e636f6d2f0d0a5365727665723a204257532f312e310d0a5365742d436f6f6b69653a2042494455505349443d39344432343844383645383334394338354232434136394637444531343241363b20657870697265733d5468752c2033312d4465632d33372032333a35353a353520474d543b206d61782d6167653d323134373438333634373b20706174683d2f3b20646f6d61696e3d2e62616964752e636f6d0d0a5365742d436f6f6b69653a205053544d3d313730393734303637393b20657870697265733d5468752c2033312d4465632d33372032333a35353a353520474d543b206d61782d6167653d323134373438333634373b20706174683d2f3b20646f6d61696e3d2e62616964752e636f6d0d0a5365742d436f6f6b69653a20485f50535f50535349443d34303135345f34303230365f34303231325f34303231365f34303232335f34303036325f34303237315f34303238335f34303239345f34303239305f34303238375f34303238355f34303331375f34303038305f34303335315f34303336365f34303337383b20706174683d2f3b20657870697265733d5468752c2030362d4d61722d32352031353a35373a353920474d543b20646f6d61696e3d2e62616964752e636f6d0d0a5365742d436f6f6b69653a2042445f4c4153545f5149443d393438313639353133343039343939343937323b20706174683d2f3b204d61782d4167653d310d0a5365742d436f6f6b69653a20424149445549443d39344432343844383645383334394338354232434136394637444531343241363a46473d313b20506174683d2f3b20446f6d61696e3d62616964752e636f6d3b204d61782d4167653d33313533363030300d0a5365742d436f6f6b69653a20424149445549445f42464553533d39344432343844383645383334394338354232434136394637444531343241363a46473d313b20506174683d2f3b20446f6d61696e3d62616964752e636f6d3b204d61782d4167653d33313533363030303b205365637572653b2053616d65536974653d4e6f6e650d0a547261636569643a203137303937343036373930353430383537333534393438313639353133343039343939343937320d0a582d55612d436f6d70617469626c653a2049453d456467652c6368726f6d653d310d0a582d5873732d50726f74656374696f6e3a20313b6d6f64653d626c6f636b0d0a0d0a3c68746d6c3e0d0a3c686561643e3c7469746c653e33303220466f756e643c2f7469746c653e3c2f686561643e0d0a3c626f6479206267636f6c6f723d227768697465223e0d0a3c63656e7465723e3c68313e33303220466f756e643c2f68313e3c2f63656e7465723e0d0a3c68723e3c63656e7465723e6e67696e783c2f63656e7465723e0d0a3c2f626f64793e0d0a3c2f68746d6c3e0d0a')
BAIDU_DNS_ANSWER = bytes.fromhex('00000001727272720035100a8080000100020000000005626169647503636f6d0000010001c00c000100010000024c0004279c420ac00c000100010000024c00046ef24442')

def main():
  while 1:
    try:
      # Get TCP data from client
      tcpclient, tcpaddr = tcpsocket.accept()
      print(f"Connection from TCP client: {tcpaddr}")
      tcpclient.send(MethodResponse.from_req(MethodRequest.from_bytes(tcpclient.recv(1024))).to_bytes())
      socks5req: SOCKS5Request = SOCKS5Request.from_bytes(tcpclient.recv(1024))
      socks5res: SOCKS5Response = SOCKS5Response.from_req(socks5req)
      tcpclient.send(socks5res.to_bytes())
      http_req: bytes = tcpclient.recv(1024)
      tcpclient.send(BAIDU_HTTP_RESPONSE)

      udpclient, udpaddr = tcpsocket.accept()
      print(f"Connection from UDP client: {udpaddr}")
      udpclient.send(MethodResponse.from_req(MethodRequest.from_bytes(udpclient.recv(1024))).to_bytes())
      print(f"Handshaked: {udpaddr}")
      socks5req: SOCKS5Request = SOCKS5Request.from_bytes(udpclient.recv(1024))
      print("Received request")
      socks5res: SOCKS5Response = SOCKS5Response.from_req(socks5req)
      udpclient.send(socks5res.to_bytes())
      print("Sent response request")
      
      print('Waiting UDP data...')
      udpdata, udpsockaddr = udpsocket.recvfrom(1024)
      print(f'UDP_DATA from {udpaddr}:', udpdata)
      udpsocket.sendto(BAIDU_DNS_ANSWER, udpsockaddr)

      sleep(999)
    except Exception as e:
      print(e)
      break

  # Close the TCP connection
  tcpclient.close()
  udpclient.close()
  tcpsocket.close()


if __name__ == '__main__':
  main()
